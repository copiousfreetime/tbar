#!/usr/bin/env ruby

require 'trollop'
require 'sequel'
require 'tbar'
require 'csv'
require 'monetize'

opts = Trollop::options do
  version "import-chart-of-accounts v#{Tbar::VERSION}"
  banner <<-EOS
  Create a new chart of accounts from an existing file. The file must be
  formatted with one account per line and the levels of the accounts separated
  by ':' characters.
  EOS

  opt :db, "The Database connection string", :default => 'postgres:///tbar'
  opt :file, "The file to import", :required => true, :type => :string
  opt :account, "The account import this CSV for", :required => true, :type => :string

  opt :date_field, "The csv column to map to the date field", :default => 'date'
  opt :note_field, "The csv column to map to the note field", :default => 'description'
  opt :amount_field, "The csv column to map to the amount field", :default => 'amount'
end

DB = Sequel.connect( opts[:db] )
chart = Tbar::ChartOfAccounts.new
DB[:accounts].select(:name).each do |row|
  a = chart.add_account( row[:name] )
end

target_account = chart.accounts_by_name[ opts[:account] ]

CSV.foreach( opts[:file], :headers => :first_row, :return_headers => false ) do |row|
  date   = Date.parse( row[opts[:date_field]] )
  note   = row[opts[:note_field]]
  amount = Monetize.parse( row[opts[:amount_field]] )

  entry = target_account.entry_for( amount )
  payee = Tbar::PayeeLookup.call( remapped[:note] )
  other = entry.paired_entry( payee.account )
  trans = Tbar::Transaction.new( :entries => [ entry, other ], :date => remapped,
                                 :note => note, :payee => payee )
  puts entry.to_s
end
